<script
  async
  src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
></script>
<script
  src="https://code.jquery.com/jquery-3.6.1.min.js"
  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
  crossorigin="anonymous"
></script>


<script>

  ///Scroll Animations

  let fps = 100;

  let introSlider = {
    path: "https://firebasestorage.googleapis.com/v0/b/gohere-24b3c.appspot.com/o/gohere%2Ftransition%2F",
    parent: document.getElementById("cart"),
    rail: document.getElementById("rail"),
    class: "heroslide",
    imgName: "colorSwirl",
    lastSlide: 0,
    currentSlide: 0,
    imgs: null,
    frames: 55
  };

  addImages(introSlider);

  var imagePromises = [];


  for (var i = 0; i < introSlider.imgs; i++) {
  var promise = new Promise(function(resolve, reject) {
    var img = new Image();
    img.src = images[i];
    img.onload = resolve;
    img.onerror = reject;
  });
  imagePromises.push(promise);
}


Promise.all(imagePromises)
  .then(function() {
      onLoad();
      alert("Images loaded correctly");
  })
  .catch(function(error) {
      console.error(error);
      alert("Images failed to load");
  });



//   window.addEventListener("load", (event) => {
//     onLoad();
//   });

  function onLoad()
  {
    
    addImagesDiv(introSlider);
    window.addEventListener("scroll", function () {
      setupScroll(introSlider);
    });

    let time = 1000 / fps;
    setInterval(() => {
      updateSlider(introSlider);

      function updateSlider(root) {
        if (root.currentSlide == root.lastSlide) return;
        else if (root.currentSlide < root.lastSlide) {
          root.lastSlide--;
          changeSlide(root.lastSlide, root);
        } else if (root.currentSlide > root.lastSlide) {
          root.lastSlide++;
          changeSlide(root.lastSlide, root);
        }
      }
    }, time);

    function changeSlide(slide, root) {
      const imgs = root.imgs;
      for (let i = 0; i < imgs.length; i++) {
        const current = imgs[i];
        if (i <= slide && i > slide - 3) {
          current.style.display = "flex";
        } else {
          current.style.display = "none";
        }
      }
    }
    function setupScroll(root) {
      const y = window.scrollY;
      const imgs = root.imgs;
      frame = imageSlider(y, root.rail, imgs);
      
      root.currentSlide = frame;
    }
  }

  function addImages(root) {
    let img = [];
    
    for (let i = 0; i < root.frames; i++) {
      if (i <= 9) {
        img.push(root.path + root.imgName + "0" + i + ".webp?alt=media");
      } else if (i <= 99) {
        img.push(root.path + root.imgName + i + ".webp?alt=media");
      }
      if (i + 1 >= root.frames) {
        
        root.imgs = img;
       
      }
    }

    
  }

  function SetCover(root)
  {
    root.imgs.forEach((img, i)=>
    {
      console.log('index:',i);
      if(i==0)
      {
        img.style.display = "flex";
      }else{
        img.style.display = "hide";
      }
    });
  }

  function addImagesDiv(root) {
    let divs = [];
    images = root.imgs;
    images.forEach((element, i) => {
      let div = document.createElement("div");
      div.style.backgroundImage = "url(" + element + ")";
      div.style.zIndex = i;
      if(i==0)
      {
        div.style.display = "flex";
      }else{
        // div.style.display = "hide";
        // console.log("Hiding image: "+element);
      }
      div.classList.add(root.class);
      preload(element);
      // root.imgs.appendChild(element);
      divs.push(div);
      root.parent.appendChild(div);
    });

    root.imgs = divs;

     //Preload
     Promise.all(Array.from(document.images).map(img => {
    if (img.complete)
        if (img.naturalHeight !== 0)
            return Promise.resolve();
        else
            return Promise.reject(img);
    return new Promise((resolve, reject) => {
        img.addEventListener('load', resolve);
        img.addEventListener('error', () => reject(img));
    });
})).then(() => {
    HideLoadScreen();
    root.imgs.forEach((element, i) => {
      // element.style.display = 'none';
    });
    root.imgs[0].style.display = 'flex';
}, badImg => {
});
  }


  function preload(url) {
    var img = new Image();
    img.src = url;
    
  }

  function HideLoadScreen()
  {
    // $('#loadscreen').hide();
    SetCover(introSlider);
  }

  function imageSlider(pixel, elem, slides) {
    let top = elem.offsetTop - 400;
    let height = elem.offsetHeight - 400;

    if (pixel > top && pixel < top + height) {
      let a = pixel - top;
      let h = height;
      let p = slides.length;

      return Math.floor((p / h) * a, 0);
    } else if (pixel >= top + height) {
      return slides.length;
    } else {
      return 0;
    }
  }


    function GetContainerInfo(div) {
      element.topPixel = $(div).offset().top;
      element.bottomPixel = $(div).position().top + $(div).outerHeight(true);
    }

  function GetScrollTop() {
    return (
      window.pageYOffset ||
      (document.documentElement || document.body.parentNode || document.body)
        .scrollTop
    );
  }

  function clamp(num, min, max) {
    return Math.min(Math.max(num, min), max);
  }

  function GetPercent(sp, t, b) {
    return (100 * (sp - t)) / (b - t);
  }

  function GetPercentage(ratio, start, end) {
    var slope = (0 - 100) / (end - start);
    var intercept = slope * -1 * start + 100;
    var mx = slope * ratio;
    percent = mx + intercept;
    percent = Math.min(Math.max(percent, -100), 100);
    return percent;
  }
  ///Reset Style for Production

  $(".removeclass").removeClass("removeclass");

   

</script>
