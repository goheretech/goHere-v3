<script
  type="module"
  src="https://cdn.jsdelivr.net/gh/goheretech/goHere-v3@
ef9c4bf186b347419b1466c683df2e018005082a
/src/script.js"
></script>

<script
  async
  src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
></script>
<script
  src="https://code.jquery.com/jquery-3.6.1.min.js"
  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
  crossorigin="anonymous"
></script>
<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.module.js",
      "OBJLoader": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/loaders/OBJLoader.js",
      "GLTFLoader": "https://unpkg.com/three@0.125.2/examples/js/loaders/GLTFLoader.js",
      "EXRLoader": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/loaders/EXRLoader.js",
      "RenderPass": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/postprocessing/RenderPass.js",
      "UnrealBloomPass": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/postprocessing/UnrealBloomPass.js",
      "EffectComposer": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/postprocessing/EffectComposer.js",
      "dat.gui": "https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"
    }
  }
</script>

<script
  type="module"
  src="https://cdn.jsdelivr.net/gh/goheretech/goHere-v3@
ef9c4bf186b347419b1466c683df2e018005082a
/src/script.js"
></script>

<script>
  ///Scroll Animations

  let fps = 80;

  const getMobileOS = () => {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) {
      return "Android";
    } else if (/iPad|iPhone|iPod/.test(ua)) {
      return "iOS";
    }
    return "Other";
  };

  let introSlider = {
    path: "https://firebasestorage.googleapis.com/v0/b/gohere-24b3c.appspot.com/o/gohere%2Ftransition%2F",
    parent: document.getElementById("backImage1"),
    rail: document.getElementById("rail1"),
    frames: undefined,
    class: "imgscene1",
    imgName: "colorSwirl",
    lastSlide: 0,
    currentSlide: 0,
  };

  if (getMobileOS() == "iOS") {
    introSlider.frames = 20;
  } else {
    introSlider.frames = 60;
  }

  let hololensSlider = {
    path: "https://firebasestorage.googleapis.com/v0/b/gohere-24b3c.appspot.com/o/gohere%2Fhololens%2F",
    parent: document.getElementById("backImage"),
    rail: document.getElementById("rail"),
    frames: 42,
    class: "imgscene",
    imgName: "a02",
    lastSlide: 0,
    currentSlide: 0,
  };

  window.addEventListener("load", (event) => {
    addImages(hololensSlider);
    addImages(introSlider);
    window.addEventListener("scroll", function () {
      setupScroll(introSlider);
      setupScroll(hololensSlider);
    });

    let time = 1000 / fps;
    setInterval(() => {
      updateSlider(introSlider);
      updateSlider(hololensSlider);

      function updateSlider(root) {
        if (root.currentSlide == root.lastSlide) return;
        else if (root.currentSlide < root.lastSlide) {
          root.lastSlide--;
          changeSlide(root.lastSlide, root);
        } else if (root.currentSlide > root.lastSlide) {
          root.lastSlide++;
          changeSlide(root.lastSlide, root);
        }
      }
    }, time);
    function changeSlide(slide, root) {
      const imgs = document.getElementsByClassName(root.class);
      for (let i = 0; i < imgs.length; i++) {
        const current = imgs[i];
        if (i < slide && i > slide - 2) {
          current.style.display = "flex";
        } else {
          current.style.display = "none";
        }
      }
    }
    function setupScroll(root) {
      const y = window.scrollY;
      const imgs = document.getElementsByClassName(root.class);
      frame = imageSlider(y, root.rail, imgs);
      root.currentSlide = frame;
    }
  });

  function addImages(root) {
    let img = [];
    for (let i = 0; i < root.frames; i++) {
      if (i <= 9) {
        img.push(root.path + root.imgName + "0" + i + ".webp?alt=media");
      } else if (i <= 99) {
        img.push(root.path + root.imgName + i + ".webp?alt=media");
      }
      if (i + 1 == root.frames) {
        addImagesDiv(img, root);
      }
    }
  }

  function addImagesDiv(images, root) {
    images.forEach((element, i) => {
      let div = document.createElement("div");
      div.style.backgroundImage = "url(" + element + ")";
      div.style.zIndex = i;
      div.classList.add(root.class);
      preload(element);

      root.parent.appendChild(div);
    });
  }
  function preload(url) {
    var img = new Image();
    img.src = url;
  }

  function imageSlider(pixel, elem, slides) {
    let top = elem.offsetTop - 400;
    let height = elem.offsetHeight - 400;

    if (pixel > top && pixel < top + height) {
      let a = pixel - top;
      let h = height;
      let p = slides.length;

      return Math.floor((p / h) * a, 0);
    } else if (pixel >= top + height) {
      return slides.length;
    } else {
      return 0;
    }
  }

  ///Color Animation

  const numSteps = 90.0;
  let prevRatio = 0;
  let goingUp;
  const options = {
    threshold: buildThresholdList(),
    rootMargin: "-5px",
  };

  const thresh = [
    [0.5, 0.75],
    [0.8, 0.4],
  ];

  function buildThresholdList() {
    let thresholds = [];

    for (let i = 1.0; i <= numSteps; i++) {
      let ratio = i / numSteps;
      thresholds.push(ratio);
    }

    thresholds.push(0);
    return thresholds;
  }

  function GetPercent(ratio, start, end) {
    var slope = (0 - 100) / (end - start);
    var intercept = slope * -1 * start + 100;
    var mx = slope * ratio;
    percent = mx + intercept;
    percent = Math.min(Math.max(percent, -100), 100);
    return percent;
  }

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const square = entry.target.querySelector(".outline");
        const square2 = entry.target.querySelector(".outline-2");
        var percent = GetPercent(
          entry.intersectionRatio,
          thresh[0][0],
          thresh[0][1]
        );

        if (percent < 0) {
          if (square2) {
            square2.style.backgroundPosition = 100 + percent + "% 100%";
          }
        } else {
          square.style.backgroundPosition = percent + "% 100%";
        }

        if (entry.boundingClientRect.top < 0) {
          if (square) {
            square.style.backgroundPosition = "0% 100%";
          }
          if (square2) {
            square2.style.backgroundPosition = "0% 100%";
          }
        }
      }
      return;
    });
  }, options);

  observer.observe(document.querySelector(".outline-wrapper"));
  observer.observe(document.querySelector(".outline-wrapper-2"));
  observer.observe(document.querySelector(".outline-wrapper-3"));
  observer.observe(document.querySelector(".outline-wrapper-4"));
  observer.observe(document.querySelector(".outline-wrapper-5"));

  ///Reset Style for Production

  $(".removeclass").removeClass("removeclass");
</script>
